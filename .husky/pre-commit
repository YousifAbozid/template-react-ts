#!/bin/bash

# Ensure we're in the project root
cd "$(git rev-parse --show-toplevel)" || {
    echo "Failed to cd to git root"
    exit 1
}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "üöÄ Running pre-commit checks..."

# Function to check for Node.js
check_node() {
    # First try the PATH
    if command -v node >/dev/null 2>&1; then
        return 0
    fi

    # Check common Node.js installation locations
    local node_paths=(
        "/usr/local/bin/node"
        "/usr/bin/node"
        "$HOME/.nvm/versions/node/*/bin/node"
        "$NVM_DIR/versions/node/*/bin/node"
        "/opt/homebrew/bin/node"
        "$HOME/.volta/bin/node"
        "$HOME/.nodenv/shims/node"
    )

    for path in "${node_paths[@]}"; do
        # Handle glob patterns
        for resolved_path in $path; do
            if [[ -x "$resolved_path" ]]; then
                # Add the directory containing node to PATH
                export PATH="$(dirname "$resolved_path"):$PATH"
                return 0
            fi
        done
    done

    return 1
}

# Check for Node.js
if ! check_node; then
    echo "${RED}‚ùå Node.js not found in PATH or common locations${NC}"
    echo "${YELLOW}Please ensure Node.js is installed and in your PATH${NC}"
    echo "Common installation methods:"
    echo "  macOS: brew install node"
    echo "  Linux: sudo apt install nodejs"
    echo "  Or visit: https://nodejs.org/"
    exit 1
fi

# Verify npm is available (should be bundled with Node.js)
if ! command -v npm >/dev/null 2>&1; then
    echo "${RED}‚ùå npm not found, but Node.js is installed${NC}"
    echo "${YELLOW}This is unusual - try reinstalling Node.js${NC}"
    exit 1
fi

# Ensure dependencies are installed
if [ ! -d "node_modules" ]; then
    echo "${YELLOW}‚ö†Ô∏è Installing dependencies...${NC}"
    npm install || {
        echo "${RED}‚ùå Failed to install dependencies${NC}"
        exit 1
    }
fi

# Run type checking
echo "Running type check..."
npm run type-check || {
    echo "${RED}‚ùå Type check failed${NC}"
    echo "Try running 'npm run type-check' manually to see the errors"
    exit 1
}

# Run lint-staged
echo "Running lint-staged..."
npx lint-staged || {
    echo "${RED}‚ùå Lint-staged failed${NC}"
    echo "Try running 'npx lint-staged' manually to see the errors"
    exit 1
}

echo "${GREEN}‚úÖ All pre-commit checks passed${NC}"